# Face Recognition Exam Sessions

Полнофункциональное веб-приложение на Python + Flask для распознавания лиц студентов и массовой загрузки базы из Excel.

## Установка и настройка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка конфигурации

Скопируйте файл с примером конфигурации:

```bash
cp .env.example .env
```

Отредактируйте `.env` файл или `config.py` для настройки:

- `FACE_RECOGNITION_THRESHOLD` - порог сходства для распознавания (по умолчанию 0.5)
- `ADMIN_TOKEN` - токен для административных функций
- `FACE_ID_DOCS_PATH` - путь к папке с документами Excel и фотографиями
- `DATABASE_URL` - URL базы данных (по умолчанию SQLite)

### 3. Подготовка данных

Создайте структуру папок для данных:

```
Face ID docs/
├── list of students.xlsx  # Excel файл со студентами
└── photos/                # Папка с фотографиями
```

Excel файл должен содержать колонки (точно в таком порядке):
- `Matricula` - номер зачетной книжки
- `Lastname` - фамилия
- `Firstname` - имя
- `Lotin` - имя латиницей
- `Short` - краткое имя
- `Group` - группа
- `Идентификатор` - уникальный идентификатор
- `Date of birth` - дата рождения
- `Passport number` - номер паспорта
- `File path` - путь к фотографии

Пути к фотографиям в Excel могут быть:
- Абсолютными: `/full/path/to/photo.jpg`
- Относительными к корню проекта: `Face ID docs/photos/student1.jpg`
- Относительными к папке photos: `student1.jpg`

## Использование

### Запуск сервера

```bash
python app.py
```

Приложение будет доступно по адресу: http://localhost:5000

### Массовая загрузка студентов

#### Через командную строку:

```bash
python loader.py --excel-path "Face ID docs/list of students.xlsx" --verbose
```

Опции:
- `--excel-path` - путь к Excel файлу (по умолчанию из конфига)
- `--force` - перезаписать существующие записи
- `--verbose` - подробный вывод

#### Через HTTP API:

```bash
curl -X POST http://localhost:5000/admin/load_excel \
  -H "Authorization: admin_secret_token_2023" \
  -F "excel_path=Face ID docs/list of students.xlsx" \
  -F "force=false"
```

Или загрузите файл напрямую:

```bash
curl -X POST http://localhost:5000/admin/load_excel \
  -H "Authorization: admin_secret_token_2023" \
  -F "excel_file=@path/to/students.xlsx" \
  -F "force=false"
```

### API Endpoints

#### Распознавание лица
```
POST /api/recognize
Content-Type: multipart/form-data

Параметры:
- image: файл изображения

Ответы:
- 200: {status: "ok", student: {...}, pass_time: "..."}
- 200: {status: "already_passed", student: {...}, first_pass_time: "..."}
- 200: {status: "not_found", message: "Лицо не найдено"}
- 400: {status: "error", message: "Найдено несколько лиц"}
```

#### Административные функции (требуют токен)

```
GET /admin/stats?token=ADMIN_TOKEN
- Получить статистику системы

POST /admin/export_report?token=ADMIN_TOKEN
- Экспорт отчета в Excel

POST /admin/rebuild_index?token=ADMIN_TOKEN
- Пересобрать индекс распознавания

POST /admin/load_excel?token=ADMIN_TOKEN
- Загрузить студентов из Excel
```

### Веб-интерфейс

Откройте http://localhost:5000 в браузере для доступа к интерфейсу с камерой:

1. Нажмите "Открыть камеру"
2. Нажмите "Сделать фото" или пробел для фотографирования
3. Результат распознавания появится ниже

Также можно загружать изображения с устройства.

## Тестирование производительности

Запустите бенчмарк для проверки производительности поиска:

```bash
python benchmarks/test_lookup.py
```

Цель: время поиска < 100 мс для 2500 записей.

Если производительность недостаточна, можно использовать FAISS или Annoy:

### Установка FAISS (опционально)

```bash
pip install faiss-cpu  # для CPU
# или
pip install faiss-gpu  # для GPU
```

Включите в конфигурации: `USE_FAISS=true`

### Установка Annoy (опционально)

```bash
pip install annoy
```

Включите в конфигурации: `USE_ANNOY=true`

## Структура проекта

```
project/
├── app.py                     # основное Flask приложение
├── models.py                  # SQLAlchemy модели
├── db.py                      # инициализация базы данных
├── face_utils.py              # функции распознавания лиц
├── loader.py                  # загрузка из Excel
├── config.py                  # конфигурация
├── requirements.txt           # зависимости
├── templates/
│   └── index.html             # веб-интерфейс
├── static/
│   └── js/main.js            # JavaScript для камеры
├── data/                      # кеш эмбеддингов
├── benchmarks/
│   └── test_lookup.py        # тесты производительности
├── Face ID docs/
│   ├── list of students.xlsx  # данные студентов
│   └── photos/               # фотографии
└── database.db               # база данных SQLite
```

## Логирование

Все действия логируются в файл `app.log`. Уровень логирования настраивается через `LOG_LEVEL`.

При загрузке из Excel формируется подробный отчет:
- Количество обработанных записей
- Количество добавленных записей  
- Количество пропущенных записей
- Список ошибок и предупреждений

## Безопасность

- Все административные функции защищены токеном
- Максимальный размер загружаемого файла: 16MB
- Валидация типов файлов
- Обработка ошибок и исключений

## Ограничения

- Распознается только одно лицо на изображении
- Поддерживаются форматы изображений: JPEG, PNG
- Повторный проход студента в тот же день блокируется
- База данных по умолчанию SQLite (можно изменить через DATABASE_URL)

## Решение проблем

### Ошибка "No face found"
- Убедитесь, что на фото четко видно лицо
- Проверьте качество и освещение изображения
- Попробуйте другую фотографию

### Ошибка "Multiple faces found"
- Убедитесь, что на фото только одно лицо
- Обрежьте изображение, оставив только нужное лицо

### Медленная работа
- Запустите `benchmarks/test_lookup.py` для проверки производительности
- Рассмотрите использование FAISS или Annoy для больших баз данных
- Проверьте ресурсы сервера (CPU, память)

### Проблемы с камерой
- Разрешите доступ к камере в браузере
- Проверьте, что камера не используется другими приложениями
- Используйте HTTPS для лучшей совместимости (особенно на мобильных устройствах)